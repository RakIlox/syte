# Malware Analysis

## Введение

Анализ вредоносного ПО — это процесс изучения поведения и структуры вредоносных программ для понимания их функциональности, создания детектов и разработки средств защиты.

## Environment Setup

### Sandbox Configuration

```bash
# Cuckoo Sandbox
# docker-compose.yml
version: '3.8'
services:
  cuckoo:
    image: cuckoosandbox/cuckoo
    ports:
      - "8000:8000"
    volumes:
      - ./volumes/cuckoo:/cuckoo
    environment:
      - CUCKOO_APIV2=1
      
  malware-storage:
    image: minio/minio
    ports:
      - "9000:9000"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
      
# Flare VM (Windows)
# https://github.com/mandiant/flare-vm
Install-ChocoPackage -PackageName flarevm
```

### Analysis Tools

```powershell
# PowerShell скрипт для сбора информации
function Invoke-BasicAnalysis {
    param($FilePath)
    
    # Hashes
    Get-FileHash $FilePath -Algorithm MD5,SHA1,SHA256
    
    # Strings
    Get-Content $FilePath | Select-String -Pattern "http|https|cmd|powershell"
    
    # PE Information
    $bytes = [System.IO.File]::ReadAllBytes($FilePath)
    $dosHeader = [System.BitConverter]::ToInt16($bytes, 0)
    
    # Imports
    $imports = Get-PEImports $FilePath
    $imports | Where-Object {$_.DLL -like "*ws2_32*"}  # Network
    
    # Exports
    Get-PEExports $FilePath
}
```

## Static Analysis

### PE Structure Analysis

```python
import pefile
import yara

# Базовая информация о файле
def analyze_pe(file_path):
    pe = pefile.PE(file_path)
    
    print(f"Machine: {pe.FILE_HEADER.Machine}")
    print(f"TimeDateStamp: {pe.FILE_HEADER.TimeDateStampString}")
    
    # Секции
    for section in pe.sections:
        print(f"\n{section.Name.strip()}")
        print(f"  VirtualSize: {hex(section.Misc_VirtualSize)}")
        print(f"  RawSize: {section.SizeOfRawData}")
        print(f"  Characteristics: {hex(section.Characteristics)}")
    
    # Импорты
    if hasattr(pe, 'DIRECTORY_ENTRY_IMPORT'):
        for entry in pe.DIRECTORY_ENTRY_IMPORT:
            print(f"\nDLL: {entry.dll}")
            for imp in entry.imports:
                if imp.name:
                    print(f"  - {imp.name}")
    
    # Экспорты
    if hasattr(pe, 'DIRECTORY_ENTRY_EXPORT'):
        for exp in pe.DIRECTORY_ENTRY_EXPORT.symbols:
            print(f"  Export: {exp.name}")
```

### YARA Rules

```yara
rule Ransomware_General {
    meta:
        author = "Malware Analyst"
        description = "Generic ransomware detection"
        severity = "critical"
    
    strings:
        $encryption_api_1 = "CryptEncrypt" fullword
        $encryption_api_2 = "CryptGenKey" fullword
        $ransom_note = "README Ransomware" nocase
        $encryption_ext1 = ".encrypted" nocase
        $encryption_ext2 = ".locked" nocase
        $bitcoin = "bitcoin" nocase
        $wallet = "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"  # Satoshi Nakamoto
        
    condition:
        uint16(0) == 0x5A4D and
        (2 of ($encryption_api_*) and 2 of ($encryption_ext*)) or
        ($ransom_note and $bitcoin)
}

rule Suspicious_Packer {
    meta:
        author = "Malware Analyst"
        description = "Detects common packers"
        
    strings:
        $upx = "UPX" nocase
        $aspack = "ASPack" nocase
        $themida = "Themida" nocase
        $vmprotect = "VMProtect" nocase
        
        // UPX specific
        $upx1 = { 55 53 50 58 }  // UPX0 section
        $upx2 = { 24 00 00 00 }  // UPX1 size
        
    condition:
        any of them
}
```

### Strings Analysis

```python
import re

def extract_iocs(file_path):
    with open(file_path, 'rb') as f:
        content = f.read()
    
    # IP addresses
    ips = re.findall(r'(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)', content.decode('latin-1'))
    
    # URLs
    urls = re.findall(r'https?://(?:[-\w.]|(?:%[\da-fA-F]{2}))+[^\s]*', content.decode('latin-1'))
    
    # Email addresses
    emails = re.findall(r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}', content.decode('latin-1'))
    
    # Registry keys
    reg_keys = re.findall(r'HKEY_[A-Z_]+\\[A-Za-z0-9\\]+', content.decode('latin-1'))
    
    # API calls
    api_calls = re.findall(r'[A-Z][a-z]+[A-Z][a-z]+', content.decode('latin-1'))
    
    return {
        'ips': list(set(ips)),
        'urls': list(set(urls)),
        'emails': list(set(emails)),
        'registry': list(set(reg_keys)),
        'apis': list(set(api_calls))
    }
```

## Dynamic Analysis

### API Monitoring

```python
# API Monitor script
import ctypes

# Перехват API вызовов
HOOKS = {
    'CreateProcess': {
        'kernel32.dll': {
            'original': None,
            'hook': hooked_CreateProcess
        }
    },
    'URLDownloadToFile': {
        'urlmon.dll': {
            'original': None,
            'hook': hooked_URLDownloadToFile
        }
    },
    'RegSetValue': {
        'advapi32.dll': {
            'original': None,
            'hook': hooked_RegSetValue
        }
    }
}

def hooked_CreateProcess(lpApplicationName, lpCommandLine, lpProcessAttributes, lpThreadAttributes, bInheritHandles, dwCreationFlags, lpEnvironment, lpCurrentDirectory, lpStartupInfo, lpProcessInformation):
    print(f"[+] CreateProcess: {lpCommandLine}")
    return original_CreateProcess(...)
```

### Network Analysis

```bash
# Wireshark фильтры
# DNS запросы
dns.qry.name contains "evil"

# HTTP POST с credentials
http.request.method == "POST" && http.file_data contains "password"

# Подозрительные протоколы
not tcp.port == 80 && not tcp.port == 443 && not tcp.port == 53

# Количество соединений
ip.addr == 192.168.1.100 && tcp.flags.syn == 1 && tcp.flags.ack == 0
```

### Registry Monitoring

```powershell
# PowerShell для мониторинга реестра
$paths = @(
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run",
    "HKLM:\SYSTEM\CurrentControlSet\Services",
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce"
)

Register-ObjectEvent -InputObject $paths[0] -EventName "KeyChange" -Action {
    Write-Host "[!] New autostart entry: $($Event.NewEvent.TargetInstance.Name)"
}

# Мониторинг создания файлов
$watcher = New-Object System.IO.FileSystemWatcher
$watcher.Path = "C:\Users\*\AppData\Roaming"
$watcher.Filter = "*.exe"
$watcher.IncludeSubdirectories = $true
$watcher.EnableRaisingEvents = $true

$action = {
    $path = $Event.SourceEventArgs.FullPath
    $name = $Event.SourceEventArgs.Name
    $time = $Event.TimeGenerated
    Write-Host "[$time] New file: $path"
}
Register-ObjectEvent $watcher "Created" -Action $action
```

## Advanced Analysis

### Unpacking

```python
import pefile
import subprocess

def unpack_upx(file_path):
    """Распаковка UPX"""
    pe = pefile.PE(file_path)
    
    # Проверка на UPX
    for section in pe.sections:
        if b'UPX' in section.Name:
            print(f"[+] UPX packed file detected")
            
            # Распаковка
            output = subprocess.run(
                ['upx', '-d', file_path, '-o', 'unpacked.exe'],
                capture_output=True
            )
            return output.returncode == 0
    return False

def manual_unpack(file_path):
    """Ручная распаковка"""
    pe = pefile.PE(file_path)
    
    # Найти OEP (Original Entry Point)
    entry_point = pe.OPTIONAL_HEADER.AddressOfEntryPoint
    print(f"Entry Point: {hex(entry_point)}")
    
    # Дать программе запуститься в отладчике
    # Снять дамп после распаковки
    # Восстановить импорты
```

### Deobfuscation

```python
# Деобфускация PowerShell
import re

def deobfuscate_powershell(script):
    # Удаление комментариев
    script = re.sub(r'#.*', '', script)
    
    # Декодирование Base64
    if script.startswith('SQBFAFgAIAAo'):
        decoded = base64.b64decode(script).decode('utf-16le')
        return decoded
    
    # Раскрытие конкатенации
    # "ho" + "st" -> "host"
    
    # Раскрытие вызовов
    $command = ('IEX', ' (', 'New', '-', 'Object')
    
    return script
```

## Report Template

```markdown
# Malware Analysis Report

## Executive Summary
| Field | Value |
|-------|-------|
| Malware Name | Trojan.GenericKD.46823 |
| SHA256 | a3f2b8c4d5e6... |
| First Seen | 2024-01-15 |
| Severity | Critical |
| Category | Ransomware |

## Static Analysis
### File Information
- **Size:** 156KB
- **Type:** PE32 executable (GUI) Intel 80386
- **Packer:** UPX 3.96

### Imports
- kernel32.dll: CreateFile, ReadFile, WriteFile
- ws2_32.dll: WSASocket, connect, send
- advapi32.dll: RegSetValue

### YARA Matches
- Rule: Ransomware_General (Score: 85)
- Rule: Suspicious_Network (Score: 70)

## Dynamic Analysis
### Behavior
- **Network:** C2 connection to 185.234.xxx.xxx:443
- **File:** Drops ransomware.exe to AppData
- **Registry:** Adds to RunOnce key
- **Process:** Creates multiple svchost.exe instances

### Network IOCs
| Type | Value |
|------|-------|
| C2 | 185.234.xxx.xxx |
| Port | 443 |
| Protocol | HTTPS |

## Recommendations
1. Block C2 domain at firewall
2. Deploy YARA rule for detection
3. Update EDR signatures
4. Block PowerShell execution from temp
```

